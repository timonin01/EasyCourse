<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ –¢–µ—Å—Ç Stepik API —Å –∫–∞–ø—á–µ–π</title>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 20px auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button { 
            background: #007cba; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover { background: #005a8b; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .response { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 15px 0; 
            border-left: 4px solid #007cba;
            white-space: pre-wrap; 
            font-family: monospace;
        }
        .error { background: #ffebee; border-left-color: #f44336; color: #c62828; }
        .success { background: #e8f5e8; border-left-color: #4caf50; color: #2e7d32; }
        .warning { background: #fff3cd; border-left-color: #ff9800; color: #856404; }
        .step {
            background: #e3f2fd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #2196f3;
        }
        #captcha-section { 
            background: #fff3e0;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #ff9800;
            display: none;
        }
        #recaptcha { margin: 15px 0; }
        .log { font-size: 12px; color: #666; margin: 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Stepik API —Å –∫–∞–ø—á–µ–π</h1>
        
        <div class="step">
            <h3>üìã –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
            <ol>
                <li>–ù–∞–∂–º–∏—Ç–µ "–¢–µ—Å—Ç 1" - –ø–æ–ª—É—á–∏—Ç–µ –æ—Ç–≤–µ—Ç —á—Ç–æ –Ω—É–∂–Ω–∞ –∫–∞–ø—á–∞</li>
                <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è reCAPTCHA</li>
                <li>–†–µ—à–∏—Ç–µ –∫–∞–ø—á—É (–ø–æ—Å—Ç–∞–≤—å—Ç–µ –≥–∞–ª–æ—á–∫—É)</li>
                <li>–ù–∞–∂–º–∏—Ç–µ "–¢–µ—Å—Ç 2" - –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ —Å —Ç–æ–∫–µ–Ω–æ–º –∫–∞–ø—á–∏</li>
                <li>–ü–æ–ª—É—á–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∫—É—Ä—Å–∞</li>
            </ol>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button onclick="testStep1()" id="btn-step1">
                üöÄ –¢–µ—Å—Ç 1: –ó–∞–ø—Ä–æ—Å –±–µ–∑ –∫–∞–ø—á–∏
            </button>
            <button onclick="testStep2()" id="btn-step2" disabled>
                ‚úÖ –¢–µ—Å—Ç 2: –ó–∞–ø—Ä–æ—Å —Å –∫–∞–ø—á–µ–π
            </button>
        </div>

        <div id="captcha-section">
            <h3>üîí –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ—à–∏—Ç—å –∫–∞–ø—á—É:</h3>
            <p>Stepik —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —á—Ç–æ –≤—ã –Ω–µ —Ä–æ–±–æ—Ç:</p>
            <div id="recaptcha"></div>
            <div class="log" id="captcha-status">–†–µ—à–∏—Ç–µ –∫–∞–ø—á—É –≤—ã—à–µ...</div>
        </div>

        <div>
            <h3>üìÑ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:</h3>
            <div id="response" class="response">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–¢–µ—Å—Ç 1" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å...</div>
        </div>

        <div>
            <h3>üìä –õ–æ–≥–∏:</h3>
            <div id="logs" class="response" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        let currentCourseId = 3;
        let siteKey = '';
        let captchaToken = null;

        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const logEntry = `[${time}] ${message}\n`;
            logs.textContent += logEntry;
            logs.scrollTop = logs.scrollHeight;
            console.log(logEntry);
        }

        // –¢–µ—Å—Ç 1: –ó–∞–ø—Ä–æ—Å –±–µ–∑ –∫–∞–ø—á–∏
        async function testStep1() {
            try {
                addLog('üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –±–µ–∑ –∫–∞–ø—á–∏...');
                document.getElementById('btn-step1').disabled = true;
                
                const response = await fetch(`http://localhost:8080/api/v1/stepik/sync-course?courseId=${currentCourseId}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                addLog('‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç
                showResponse(JSON.stringify(data, null, 2), 'info');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω–∞ –ª–∏ –∫–∞–ø—á–∞
                if (data.siteKey) {
                    addLog(`üîí –¢—Ä–µ–±—É–µ—Ç—Å—è –∫–∞–ø—á–∞! Site Key: ${data.siteKey}`);
                    showCaptcha(data.siteKey);
                } else if (data.captchaKey && data.captchaKey.match(/^\d+$/)) {
                    addLog(`üéâ –ö—É—Ä—Å —Å–æ–∑–¥–∞–Ω! Stepik ID: ${data.captchaKey}`);
                    showResponse(`üéâ –£—Å–ø–µ—Ö –±–µ–∑ –∫–∞–ø—á–∏!\n\nStepik Course ID: ${data.captchaKey}\nMessage: ${data.message}`, 'success');
                } else {
                    addLog('‚ùì –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç');
                }
                
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                showResponse(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:\n\n${error.message}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n1. –ó–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 8080\n2. –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫—É—Ä—Å —Å ID=${currentCourseId}`, 'error');
            } finally {
                document.getElementById('btn-step1').disabled = false;
            }
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–ø—á—É
        function showCaptcha(captchaSiteKey) {
            siteKey = captchaSiteKey;
            document.getElementById('captcha-section').style.display = 'block';
            
            addLog(`üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º reCAPTCHA —Å site key: ${siteKey}`);
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∫–∞–ø—á—É –µ—Å–ª–∏ –±—ã–ª–∞
            document.getElementById('recaptcha').innerHTML = '';
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤—É—é reCAPTCHA
            try {
                grecaptcha.render('recaptcha', {
                    'sitekey': siteKey,
                    'callback': onCaptchaSuccess,
                    'expired-callback': onCaptchaExpired
                });
                addLog('‚úÖ reCAPTCHA –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                document.getElementById('captcha-status').textContent = '–†–µ—à–∏—Ç–µ –∫–∞–ø—á—É –≤—ã—à–µ —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å...';
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ reCAPTCHA: ${error.message}`);
            }
        }

        // –ö–∞–ø—á–∞ —Ä–µ—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
        function onCaptchaSuccess(token) {
            captchaToken = token;
            addLog(`‚úÖ –ö–∞–ø—á–∞ —Ä–µ—à–µ–Ω–∞! –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω (${token.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
            document.getElementById('captcha-status').textContent = '‚úÖ –ö–∞–ø—á–∞ —Ä–µ—à–µ–Ω–∞! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å.';
            document.getElementById('btn-step2').disabled = false;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ —Å–∏–º–≤–æ–ª—ã —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            addLog(`üîç –¢–æ–∫–µ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å: ${token.substring(0, 30)}...`);
        }

        // –ö–∞–ø—á–∞ –∏—Å—Ç–µ–∫–ª–∞
        function onCaptchaExpired() {
            captchaToken = null;
            addLog('‚ö†Ô∏è –ö–∞–ø—á–∞ –∏—Å—Ç–µ–∫–ª–∞, —Ä–µ—à–∏—Ç–µ –∑–∞–Ω–æ–≤–æ');
            document.getElementById('captcha-status').textContent = '‚ö†Ô∏è –ö–∞–ø—á–∞ –∏—Å—Ç–µ–∫–ª–∞, —Ä–µ—à–∏—Ç–µ –∑–∞–Ω–æ–≤–æ';
            document.getElementById('btn-step2').disabled = true;
        }

        // –¢–µ—Å—Ç 2: –ó–∞–ø—Ä–æ—Å —Å –∫–∞–ø—á–µ–π
        async function testStep2() {
            if (!captchaToken) {
                alert('–°–Ω–∞—á–∞–ª–∞ —Ä–µ—à–∏—Ç–µ –∫–∞–ø—á—É!');
                return;
            }

            try {
                addLog('üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å —Ç–æ–∫–µ–Ω–æ–º –∫–∞–ø—á–∏...');
                document.getElementById('btn-step2').disabled = true;
                
                const url = `http://localhost:8080/api/v1/stepik/sync-course?courseId=${currentCourseId}&captchaToken=${encodeURIComponent(captchaToken)}`;
                addLog(`üì° URL: ${url.substring(0, 100)}...`);
                
                const response = await fetch(url, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                addLog('‚úÖ –û—Ç–≤–µ—Ç —Å –∫–∞–ø—á–µ–π –ø–æ–ª—É—á–µ–Ω');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                showResponse(JSON.stringify(data, null, 2), 'info');
                
                if (data.captchaKey && data.captchaKey.match(/^\d+$/)) {
                    addLog(`üéâ –£–°–ü–ï–•! –ö—É—Ä—Å —Å–æ–∑–¥–∞–Ω –≤ Stepik —Å ID: ${data.captchaKey}`);
                    showResponse(`üéâ –ö—É—Ä—Å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!\n\nStepik Course ID: ${data.captchaKey}\nMessage: ${data.message}`, 'success');
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞–ø—á—É –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
                    document.getElementById('captcha-section').style.display = 'none';
                } else if (data.siteKey) {
                    addLog('‚ö†Ô∏è –í—Å—ë –µ—â—ë —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–∞–ø—á–∞, –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫');
                    showResponse(`‚ö†Ô∏è –ö–∞–ø—á–∞ –≤—Å—ë –µ—â—ë —Ç—Ä–µ–±—É–µ—Ç—Å—è\n\n–í–æ–∑–º–æ–∂–Ω–æ —Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω.\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–µ—à–∏—Ç—å –∫–∞–ø—á—É –∑–∞–Ω–æ–≤–æ.`, 'warning');
                } else {
                    addLog('‚ùì –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞–ø—á–∏');
                }
                
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å –∫–∞–ø—á–µ–π: ${error.message}`);
                showResponse(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å –∫–∞–ø—á–µ–π:\n\n${error.message}`, 'error');
            } finally {
                // –†–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–∞–ø—á–∞ –≤—Å—ë –µ—â—ë —Ä–µ—à–µ–Ω–∞
                if (captchaToken) {
                    document.getElementById('btn-step2').disabled = false;
                }
            }
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        function showResponse(text, type) {
            const responseDiv = document.getElementById('response');
            responseDiv.textContent = text;
            responseDiv.className = `response ${type}`;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        addLog('üîß –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≥–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é');
        addLog(`üìã –ë—É–¥–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å courseId=${currentCourseId}`);
        addLog('üí° –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:8080');
    </script>
</body>
</html>
